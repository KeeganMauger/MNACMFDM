
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>ELEC 4700 Assignment 4</title><meta name="generator" content="MATLAB 9.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-04-09"><meta name="DC.source" content="CMA4.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>ELEC 4700 Assignment 4</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Circuit Modeling</a></li><li><a href="#2">Section 1: Revisiting PA7 and Assignment 3</a></li><li><a href="#3">Section 1.1: Finding the Resistance of R3</a></li><li><a href="#4">Section 1.2: Calculating the resistance of R3</a></li><li><a href="#5">Section 1.3: The C and G matricies</a></li><li><a href="#6">Section 1.4: DC Sweep of Vin from -10V to 10V</a></li><li><a href="#7">Section 1.5: The AC Case; Vout as a function of w</a></li><li><a href="#8">Section 1.6: The AC Case; Plotting Vo/Vi in dB</a></li></ul></div><h2 id="1">Circuit Modeling</h2><p>Keegan Mauger 101042551</p><h2 id="2">Section 1: Revisiting PA7 and Assignment 3</h2><p>In section 1, the MNA modeling done in PA7 and the monte-carlo/finite difference method code devoloped in assignment 3 are combined. First, assignment 3 is repurposed to find the resistance of R3 from PA7.</p><h2 id="3">Section 1.1: Finding the Resistance of R3</h2><p>The width of the bottleneck from assignment 3 was modified to find a resistance suggested by the TAs. First, teh assignment code was re-run to find a plot of the average current vs Vin.</p><pre class="codeinput">clear <span class="string">all</span>
close <span class="string">all</span>
clc
<span class="comment">%set(0,'DefaultFigureWindowStyle','docked')</span>
set(0,<span class="string">'defaultaxesfontsize'</span>,10)
set(0,<span class="string">'defaultaxesfontname'</span>,<span class="string">'Times New Roman'</span>)
set(0,<span class="string">'DefaultLineLineWidth'</span>, 0.5);

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Finite Difference Method Simulation</span>
<span class="comment">%--------------------------------------------------------------------------</span>


Zfac = 15e-9;
Vin = linspace(0.1,10,30);
Complete = linspace(0,100,30);
<span class="keyword">for</span> J=1:length(Vin)
<span class="comment">%fprintf('\n%3.2f percent complete',Complete(J));</span>
<span class="comment">% Fixed bottleneck of 0.2x10-7m</span>
<span class="comment">% Solving V=V0 @ x=0 and V=0 @ x=L in region LxW</span>
<span class="comment">% Implement funtion 'pbaspect' to fix Z aspect ratio</span>
clearvars <span class="string">-except</span> <span class="string">Vin</span> <span class="string">J</span> <span class="string">Ix_total</span> <span class="string">Iavg</span> <span class="string">Zfac</span> <span class="string">Complete</span>

Conc = 1e19;
L = 200e-9;
W = 100e-9;
V0 = Vin(J);

fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
La = linspace(0,L,nx);
Wa = linspace(0,W,ny);
G = sparse(nx*ny);
<span class="comment">%V = sparse(nx,ny);</span>
F = sparse(1,nx*ny);


Acond = 1;              <span class="comment">% background conductivity of region, low resistance</span>
Bcond = 1e-2;           <span class="comment">% Conductivity of boxes, highly resistive</span>
cMap = zeros(nx,ny);
Lb = 40e-9;
Wb = 40e-9;
<span class="keyword">for</span> u = 1:nx
    <span class="keyword">for</span> v = 1:ny
        <span class="keyword">if</span> (u &gt;= 80 &amp;&amp; u &lt;= 120)
            <span class="keyword">if</span> v &gt;= 0 &amp;&amp; v &lt;= 40-1+J
                cMap(u,v) = Bcond;
            <span class="keyword">elseif</span> v &gt;= 60+1-J &amp;&amp; v &lt;= 100
                cMap(u,v) = Bcond;
            <span class="keyword">else</span>
                cMap(u,v) = Acond;
            <span class="keyword">end</span>
        <span class="keyword">else</span>
            cMap(u,v) = Acond;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>





<span class="keyword">for</span> i = 1:nx                <span class="comment">%Iteration through length</span>
    <span class="keyword">for</span> j = 1:ny            <span class="comment">%Iteration through width</span>
        n = j + (i-1)*ny;

        <span class="keyword">if</span> i == 1          <span class="comment">% x=0 BCs</span>
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = V0;
        <span class="keyword">elseif</span> i == nx     <span class="comment">% x=1 BCs</span>
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = 0;       <span class="comment">%F(n)=0 sets z at final width to 0</span>

<span class="comment">% COMMENT BELOW FOR 1a</span>
            <span class="comment">%F(n) = 1;       %F(n)=1 sets z at final width to 1</span>

        <span class="keyword">elseif</span> j == 1                 <span class="comment">% y=0 BCs</span>
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;

            G(n,n) = -(rxm+rxp+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nyp) = ryp;

        <span class="keyword">elseif</span> j == ny                <span class="comment">% y=1 BCs</span>
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;

            G(n,n) = -(rxm+rxp+rym);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;


<span class="comment">% COMMENT ABOVE FOR 1a</span>

        <span class="keyword">else</span>
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;

            G(n,n) = -(rxm+rxp+rym+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;
            G(n,nyp) = ryp;
        <span class="keyword">end</span>

    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">% figure(1)</span>
<span class="comment">% spy(G)</span>

V = G\F';

Vmap = zeros(nx,ny);
<span class="keyword">for</span> i = 1:nx
    <span class="keyword">for</span> j = 1:ny
        n = j + (i-1)*ny;
        Vmap(i,j) = V(n);
    <span class="keyword">end</span>
<span class="keyword">end</span>


<span class="keyword">for</span> i = 1:nx
    <span class="keyword">for</span> j = 1:ny
        <span class="keyword">if</span> i == 1
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i, j));
        <span class="keyword">elseif</span> i == nx
            Ex(i, j) = (Vmap(i, j) - Vmap(i - 1, j));
        <span class="keyword">else</span>
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i - 1, j)) * 0.5;
        <span class="keyword">end</span>
        <span class="keyword">if</span> j == 1
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j));
        <span class="keyword">elseif</span> j == ny
            Ey(i, j) = (Vmap(i, j) - Vmap(i, j - 1));
        <span class="keyword">else</span>
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j - 1)) * 0.5;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

Ex = -Ex;
Ey = -Ey;

eFlowx = cMap .* Ex;        <span class="comment">%Jx</span>
eFlowy = cMap .* Ey;        <span class="comment">%Jy</span>
C0 = sum(eFlowx(1, :));
Cnx = sum(eFlowx(nx, :));
Curr = (C0 + Cnx) * 0.5;

Ex = Ex';
Ey = Ey';

<span class="comment">% figure(4)</span>
<span class="comment">% subplot(1, 2, 2), quiver(Ex, Ey);</span>
<span class="comment">% axis([0 nx 0 ny]);</span>
<span class="comment">% title('Electric Field Map')</span>
<span class="comment">% xlabel('Region Length')</span>
<span class="comment">% ylabel('Region Width')</span>
<span class="comment">% pbaspect([1 1 0.5])</span>
<span class="comment">% subplot(1, 2, 1), H = surf(La,Wa,Vmap');</span>
<span class="comment">% set(H, 'linestyle', 'none');</span>
<span class="comment">% %view(90, 270)</span>
<span class="comment">% title('Voltage Map')</span>
<span class="comment">% xlabel('Region Length')</span>
<span class="comment">% ylabel('Region Width')</span>
<span class="comment">% pbaspect([1 1 0.5])</span>
<span class="comment">% saveas(gcf,'Figure4')</span>

<span class="comment">% clearvars -except Ex Ey</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Beginning Monte Carlo Simulation</span>
<span class="comment">%--------------------------------------------------------------------------</span>


set(0,<span class="string">'DefaultFigureWindowStyle'</span>,<span class="string">'docked'</span>)
set(0,<span class="string">'defaultaxesfontsize'</span>,10)
set(0,<span class="string">'defaultaxesfontname'</span>,<span class="string">'Times New Roman'</span>)
set(0,<span class="string">'DefaultLineLineWidth'</span>, 0.5);



<span class="keyword">global</span> C

C.q_0 = 1.60217653e-19;             <span class="comment">% electron charge</span>
C.hb = 1.054571596e-34;             <span class="comment">% Dirac constant</span>
C.h = C.hb * 2 * pi;                <span class="comment">% Planck constant</span>
C.m_0 = 9.10938215e-31;             <span class="comment">% electron mass</span>
C.kb = 1.3806504e-23;               <span class="comment">% Boltzmann constant</span>
C.eps_0 = 8.854187817e-12;          <span class="comment">% vacuum permittivity</span>
C.mu_0 = 1.2566370614e-6;           <span class="comment">% vacuum permeability</span>
C.c = 299792458;                    <span class="comment">% speed of light</span>
C.g = 9.80665;                      <span class="comment">% metres (32.1740 ft) per s&sup2;</span>
C.m_n = 0.26 * C.m_0;               <span class="comment">% effective electron mass</span>
C.am = 1.66053892e-27;              <span class="comment">% atomic mass unit</span>
C.T = 300;
C.vth = sqrt(2*C.kb * C.T / C.m_n);

temp = C.T;

SPECDIFF_BOUND = 0;

<span class="comment">% figure(3)</span>
<span class="comment">% subplot(2,1,1);</span>
<span class="comment">% rectangle('Position',[0 0 200e-9 100e-9])</span>
<span class="comment">% hold on</span>
<span class="comment">% rectangle('Position',[0.8e-7 0 0.4e-7 0.4e-7])</span>
<span class="comment">% hold on</span>
<span class="comment">% rectangle('Position',[0.8e-7 0.6e-7 0.4e-7 0.4e-7])</span>
<span class="comment">% hold on</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Initializing Positions</span>
<span class="comment">%--------------------------------------------------------------------------</span>

    N = 30000;        <span class="comment">% Number of electrons</span>
    i = 0;
    j = 0;

    <span class="keyword">for</span> i=1:N
        px(i) = 0 + (200e-9 - 0).*rand(1,1);
        py(i) = 0 + (100e-9 - 0).*rand(1,1);
        <span class="keyword">while</span> (0.8e-7 &lt;= px(i) &amp;&amp; px(i) &lt;= 1.2e-7) &amp;&amp; (0 &lt;= py(i) &amp;&amp; py(i) &lt;= (0.4e-7 - Zfac) ) ||<span class="keyword">...</span>
                (0.8e-7 &lt;= px(i) &amp;&amp; px(i) &lt;= 1.2e-7) &amp;&amp; ((0.6e-7 + Zfac) &lt;= py(i) &amp;&amp; py(i) &lt;= 1e-7)
            px(i) = 0 + (200e-9 - 0).*rand(1,1);
            py(i) = 0 + (100e-9 - 0).*rand(1,1);
        <span class="keyword">end</span>
    <span class="keyword">end</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Voltage Applied Across x-Dimension to Find Electric Field</span>
<span class="comment">%--------------------------------------------------------------------------</span>

    V0x = Vin(J);
    V0y = 0;
    L = 200e-9;
    W = 100e-9;
    <span class="comment">% E0x = V0x / L;</span>
    <span class="comment">% E0y = V0y / W;</span>
    fMesh = 1;
    nx = fMesh*200;
    ny = fMesh*100;
    <span class="comment">% G = sparse(nx,ny);</span>
    <span class="comment">% F = sparse(1,nx*ny);</span>

    La = linspace(0,L,nx);
    Wa = linspace(0,W,ny);

    deltax = L/nx;
    deltay = W/ny;

    Ex = Ex./deltax;
    Ey = Ey./deltay;

    <span class="comment">% Emapx = zeros(ny,nx);</span>
    Emapx = Ex;
    <span class="comment">% Emapy = zeros(ny,nx);</span>
    Emapy = Ey;

    <span class="comment">% for i = 1:width(La)</span>
    <span class="comment">%     for j = 1:width(Wa)</span>
    <span class="comment">%         Emapx(j,i) = E0x;</span>
    <span class="comment">%         Emapy(j,i) = E0y;</span>
    <span class="comment">%     end</span>
    <span class="comment">% end</span>
    <span class="comment">% %surf(La,Wa,Emapx)</span>
    <span class="comment">%</span>
    <span class="comment">% Fex = abs(C.q_0*E0x);</span>
    <span class="comment">% aex = Fex/C.m_n;</span>
    <span class="comment">% Fey = abs(C.q_0*E0y);</span>
    <span class="comment">% aey = Fey/C.m_n;</span>

    Fex = zeros(ny,nx);
    aex = zeros(ny,nx);
    Fey = zeros(ny,nx);
    aey = zeros(ny,nx);

    <span class="keyword">for</span> i = 1:width(Wa)
        <span class="keyword">for</span> j = 1:width(La)
            Fex(i,j) = abs(C.q_0*Emapx(i,j));
            aex(i,j) = Fex(i,j)/C.m_n;
            Fey(i,j) = abs(C.q_0*Emapy(i,j));
            aey(i,j) = Fey(i,j)/C.m_n;
        <span class="keyword">end</span>
    <span class="keyword">end</span>





<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Thermal Velocity and Direction</span>
<span class="comment">%--------------------------------------------------------------------------</span>

    vth = C.vth;

    <span class="keyword">for</span> j=1:N
        vx(j) = (vth/sqrt(2))*randn();
        vy(j) = (vth/sqrt(2))*randn();
        vth_calc(j) = sqrt(vx(j)^2 + vy(j)^2);
    <span class="keyword">end</span>


    t = 0;
    T(1) = 0;
    dt = 1e-14;     <span class="comment">% time step</span>

    <span class="keyword">for</span> l=1:N           <span class="comment">%Scattering time step</span>
        ndt(l) = dt;
    <span class="keyword">end</span>
    P_scat = 0;
    Tmn = 0.2e-12;

    px_prev = 0;
    py_prev = 0;
    T_prev = 0;
    vx_total = 0;
    vy_total = 0;

    sampleidx = randi(N,10,1);
    Ix = 0;
    Jx = 0;
    aex = aex';
    aey = aey';




    <span class="keyword">for</span> t=2:1000
        vx_total = 0;
        vy_total = 0;
        <span class="keyword">for</span> k=1:N

            rpx = 0;
            rpy = 0;
            <span class="keyword">if</span> px(k) == 200e-9
                px(k) = 0;
                px_prev(k) = px(k);
            <span class="keyword">elseif</span> px(k) == 0
                px(k) = 200e-9;
                px_prev(k) = px(k);
            <span class="keyword">else</span>
                px(k) = px(k);
            <span class="keyword">end</span>

            P_scat(k) = 1 - exp(-(dt/Tmn));
            <span class="keyword">if</span> P_scat(k) &gt; rand()
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            <span class="keyword">else</span>
                ndt(k) = ndt(k) + dt;
            <span class="keyword">end</span>

            px_prev(k) = px(k);
            py_prev(k) = py(k);

            rpx = round(px(k)*1e9);
            <span class="keyword">if</span> rpx == 0
                rpx = 1;
            <span class="keyword">end</span>
            rpy = round(py(k)*1e9);
            <span class="keyword">if</span> rpy == 0
                rpy = 1;
            <span class="keyword">end</span>



            px(k) = px(k) + vx(k)*dt + aex(rpx,rpy)*dt^2;        <span class="comment">% Adding acceleration</span>
            vx(k) = vx(k) + aex(rpx,rpy)*dt;
            py(k) = py(k) + vy(k)*dt + aey(rpx,rpy)*dt^2;
            vy(k) = vy(k) + aey(rpx,rpy)*dt;


            <span class="comment">% Reflection on top and bottom borders</span>
            <span class="keyword">if</span> py(k) &gt;= 100e-9 || py(k) &lt;= 0
                vy(k) = -vy(k);
                <span class="keyword">if</span> py(k) &gt;= 100e-9
                    py(k) = 100e-9;
                <span class="keyword">end</span>
                <span class="keyword">if</span> py(k) &lt;= 0
                    py(k) = 0;
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">% Reflection on bottom of upper box</span>
            <span class="keyword">if</span> (py(k) &gt;= (0.6e-7 + Zfac)) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)<span class="keyword">...</span>
                    &amp;&amp; ( 0.8e-7 &lt;= px_prev(k) &amp;&amp; px_prev(k) &lt;= 1.2e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vy(k) = -vy(k);
                <span class="keyword">end</span>
                py(k) = 0.601e-7 + Zfac;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on top of lower box</span>
            <span class="keyword">elseif</span> (py(k) &lt;= 0.4e-7 - Zfac) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)<span class="keyword">...</span>
                    &amp;&amp; (0.8e-7 &lt;= px_prev(k) &amp;&amp; px_prev(k) &lt;= 1.2e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vy(k) = -vy(k);
                <span class="keyword">end</span>
                py(k) = 0.399e-7 - Zfac;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on left of lower box</span>
            <span class="keyword">elseif</span> (0 &lt;= py(k) &amp;&amp; py(k) &lt;= 0.4e-7 - Zfac) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vx(k) = -vx(k);
                <span class="keyword">end</span>
                px(k) = 0.799e-7;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on right of lower box</span>
            <span class="keyword">elseif</span> (0 &lt;= py(k) &amp;&amp; py(k) &lt;= 0.4e-7 - Zfac) &amp;&amp; (1e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vx(k) = -vx(k);
                <span class="keyword">end</span>
                px(k) = 1.201e-7;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on left of upper box</span>
            <span class="keyword">elseif</span> (0.6e-7 + Zfac &lt;= py(k) &amp;&amp; py(k) &lt;= 1e-7) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vx(k) = -vx(k);
                <span class="keyword">end</span>
                px(k) = 0.799e-7;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on right of upper box</span>
            <span class="keyword">elseif</span> (0.6e-7 + Zfac &lt;= py(k) &amp;&amp; py(k) &lt;= 1e-7) &amp;&amp; (1e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vx(k) = -vx(k);
                <span class="keyword">end</span>
                px(k) = 1.201e-7;
            <span class="keyword">end</span>

            <span class="comment">% x-axis transition</span>
            <span class="keyword">if</span> px(k) &gt; 200e-9
                px(k) = 200e-9;
                <span class="comment">%             px_prev(k) = px(k);</span>
            <span class="keyword">elseif</span> px(k) &lt; 0
                px(k) = 0;
                <span class="comment">%             px_prev(k) = px(k);</span>
            <span class="keyword">else</span>
                px(k) = px(k);
            <span class="keyword">end</span>

            v(k) = sqrt(vx(k)^2 + vy(k)^2);
            v2(k) = v(k).*v(k);

            vx_total = vx_total + vx(k);        <span class="comment">% Drift velocity x</span>
            vy_total = vy_total + vy(k);        <span class="comment">% Drift velocity y</span>
        <span class="keyword">end</span>
        vx_total_alt = sum(vx);



        vx_drift = 1/N * vx_total;
        vy_drift = 1/N * vy_total;
        Jx = C.q_0 * Conc * vx_drift;   <span class="comment">%Concentration = 1e19 per m^-2</span>
        Ix_prev = Ix;
        Ix = Jx * W;
        Ix_total(t) = Ix;



    <span class="keyword">end</span>


    Iavg(J) = mean(Ix_total);
    <span class="comment">%bottleneck(J) = 20e-9 - (2*g) + 2e-9;</span>


<span class="keyword">end</span>

figure(1)
plot(Vin,Iavg)
xlabel(<span class="string">'Input Voltage (V)'</span>)
ylabel(<span class="string">'Average Current (A)'</span>)
title(<span class="string">'Average Current VS Input Voltage'</span>)
saveas(gcf,<span class="string">'Figure1'</span>)
</pre><img vspace="5" hspace="5" src="CMA4_01.png" alt=""> <h2 id="4">Section 1.2: Calculating the resistance of R3</h2><p>The solved resistance of R3 was then found to be approximately 51.32 ohms, found through a linear fit of the plot.</p><pre class="codeinput">linFit = polyfit(Vin,Iavg,1);
G3 = linFit(1);
R3 = 1/G3;

fprintf(<span class="string">'\nThe resistance of R3 is %f ohms.'</span>,R3);
clearvars <span class="string">-except</span> <span class="string">R3</span>
</pre><pre class="codeoutput">
The resistance of R3 is 51.257629 ohms.</pre><h2 id="5">Section 1.3: The C and G matricies</h2><p>Using code from PA7, the C and G matricies of the circuit were formed are are displayed below.</p><pre class="codeinput"><span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Reusing Modified Nodal Analysis Code for Circuit - DC Case</span>
<span class="comment">%--------------------------------------------------------------------------</span>

<span class="keyword">global</span> G b C
nodes = 6;
G = sparse(nodes,nodes);
C = sparse(nodes,nodes);
b = sparse(nodes,1);

<span class="comment">% MNA setup</span>
Vin = 1;
Vprobe = 0;
R1 = 1;
R2 = 2;
<span class="comment">%R3 = 10; %R3 found in part 1</span>
R4 = 0.1;
R5 = 1000;
C1 = 0.25;
L1 = 0.2;
alpha = 100;

cap(1,2,C1);
res(1,2,R1);
res(2,0,R2);
res(3,6,R3);
res(4,5,R4);
res(5,0,R5);
xr = vol(6,0,Vprobe);
ind(2,3,L1);
vol(1,0,Vin);
vcvs(4,0,xr,0,alpha);

w = 0;
s = j*w;

A = G + s*C;
A0 = full(A);
G0 = full(G);
C0 = full(C);

fprintf(<span class="string">'\nThe G matrix is given as:\n'</span>);
disp(G0);

fprintf(<span class="string">'\nThe C matrix is given as:\n'</span>);
disp(C0);
</pre><pre class="codeoutput">
The G matrix is given as:
  Columns 1 through 7

    1.0000   -1.0000         0         0         0         0         0
   -1.0000    1.5000         0         0         0         0         0
         0         0    0.0195         0         0   -0.0195         0
         0         0         0   10.0000  -10.0000         0         0
         0         0         0  -10.0000   10.0010         0         0
         0         0   -0.0195         0         0    0.0195    1.0000
         0         0         0         0         0    1.0000         0
         0    1.0000   -1.0000         0         0         0         0
    1.0000         0         0         0         0         0         0
         0         0         0    1.0000         0         0 -100.0000

  Columns 8 through 10

         0    1.0000         0
    1.0000         0         0
   -1.0000         0         0
         0         0    1.0000
         0         0         0
         0         0         0
         0         0         0
         0         0         0
         0         0         0
         0         0         0


The C matrix is given as:
  Columns 1 through 7

    0.2500   -0.2500         0         0         0         0         0
   -0.2500    0.2500         0         0         0         0         0
         0         0         0         0         0         0         0
         0         0         0         0         0         0         0
         0         0         0         0         0         0         0
         0         0         0         0         0         0         0
         0         0         0         0         0         0         0
         0         0         0         0         0         0         0
         0         0         0         0         0         0         0
         0         0         0         0         0         0         0

  Columns 8 through 10

         0         0         0
         0         0         0
         0         0         0
         0         0         0
         0         0         0
         0         0         0
         0         0         0
   -0.2000         0         0
         0         0         0
         0         0         0

</pre><h2 id="6">Section 1.4: DC Sweep of Vin from -10V to 10V</h2><p>Next, the value of Vin (at node 1) was swept from -10V to 10V and the resulting output at node 3 and the output were plotted.</p><pre class="codeinput">V0 = linspace(-10,10,21);
b0 = sparse((width(G)),width(V0));
<span class="keyword">for</span> i = 1:width(V0)
    b0(9,i) = V0(i);
<span class="keyword">end</span>

x = sparse((width(G)),width(V0));

<span class="keyword">for</span> j = 1:width(V0)
    x(:,j) = (G + s*C) \ b0(:,j);
<span class="keyword">end</span>

figure(2)
plot(V0,x(5,:))
hold <span class="string">on</span>
plot(V0,x(3,:))
grid <span class="string">on</span>
axis([-10 10 -100 100])
title(<span class="string">'Vout vs Vin'</span>)
xlabel(<span class="string">'Vin'</span>)
ylabel(<span class="string">'Vout'</span>)
legend(<span class="string">'Vout'</span>,<span class="string">'V3'</span>)
saveas(gcf,<span class="string">'Figure2'</span>)
hold <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="CMA4_02.png" alt=""> <h2 id="7">Section 1.5: The AC Case; Vout as a function of w</h2><p>Vout was then plotted as a function of w (omega), where omega was swept from 0Hz to 100Hz over 100 points.</p><pre class="codeinput"><span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% AC Case</span>
<span class="comment">%--------------------------------------------------------------------------</span>

clearvars <span class="string">-except</span> <span class="string">R3</span>
<span class="keyword">global</span> G b C
nodes = 6;
G = sparse(nodes,nodes);
C = sparse(nodes,nodes);
b = sparse(nodes,1);

<span class="comment">% MNA setup</span>
Vin = 1;
Vprobe = 0;
R1 = 1;
R2 = 2;
<span class="comment">%R3 = 10;</span>
R4 = 0.1;
R5 = 1000;
C1 = 0.25;
L1 = 0.2;
alpha = 100;

cap(1,2,C1);
res(1,2,R1);
res(2,0,R2);
res(3,6,R3);
res(4,5,R4);
res(5,0,R5);
xr = vol(6,0,Vprobe);
ind(2,3,L1);
vol(1,0,Vin);
vcvs(4,0,xr,0,alpha);

w = linspace(0,100,100);
s = j*w;

<span class="comment">% A = G + s.*C;</span>
<span class="comment">% A0 = full(A);</span>

<span class="comment">%V0 = linspace(-10,10,21);</span>
<span class="comment">% b0 = sparse((width(G)),width(w));</span>
<span class="comment">% for i = 1:width(w)</span>
<span class="comment">%     b0(6,i) = V0(i);</span>
<span class="comment">% end</span>

<span class="comment">% x = (G + s*C) \ b;</span>
x = sparse((width(G)),width(w));

<span class="keyword">for</span> i = 1:width(w)
    x(:,i) = (G + s(i)*C) \ b;
<span class="keyword">end</span>

figure(3)
plot(w,abs(x(5,:)))
<span class="comment">%hold on</span>
<span class="comment">%plot(w,abs(x(3,:)))</span>
grid <span class="string">on</span>
title(<span class="string">'|Vout| vs Frequency'</span>)
xlabel(<span class="string">'Frequency (Hz)'</span>)
ylabel(<span class="string">'Voltage (V)'</span>)
<span class="comment">%legend('Vout','V3')</span>
saveas(gcf,<span class="string">'Figure3'</span>)
hold <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="CMA4_03.png" alt=""> <h2 id="8">Section 1.6: The AC Case; Plotting Vo/Vi in dB</h2><p>The gain of Vout over Vin was also plotted, in dB.</p><pre class="codeinput">mag = abs(x(5,:)./x(1,:));
gain = mag2db(mag);
figure(4)
plot(w,gain)
grid <span class="string">on</span>
title(<span class="string">'Gain vs Frequency'</span>)
ylabel(<span class="string">'Gain (dB)'</span>)
xlabel(<span class="string">'Frequency'</span>)
saveas(gcf,<span class="string">'Figure4'</span>)
</pre><img vspace="5" hspace="5" src="CMA4_04.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2021b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% ELEC 4700 Assignment 4
%%% Circuit Modeling
% Keegan Mauger
% 101042551

%% Section 1: Revisiting PA7 and Assignment 3
% In section 1, the MNA modeling done in PA7 and the monte-carlo/finite
% difference method code devoloped in assignment 3 are combined. First,
% assignment 3 is repurposed to find the resistance of R3 from PA7.

%% Section 1.1: Finding the Resistance of R3
% The width of the bottleneck from assignment 3 was modified to find a
% resistance suggested by the TAs. First, teh assignment code was re-run to
% find a plot of the average current vs Vin. 

clear all
close all
clc
%set(0,'DefaultFigureWindowStyle','docked')
set(0,'defaultaxesfontsize',10)
set(0,'defaultaxesfontname','Times New Roman')
set(0,'DefaultLineLineWidth', 0.5);

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Finite Difference Method Simulation
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH


Zfac = 15e-9;
Vin = linspace(0.1,10,30);
Complete = linspace(0,100,30);
for J=1:length(Vin)
%fprintf('\n%3.2f percent complete',Complete(J));
% Fixed bottleneck of 0.2x10-7m
% Solving V=V0 @ x=0 and V=0 @ x=L in region LxW
% Implement funtion 'pbaspect' to fix Z aspect ratio
clearvars -except Vin J Ix_total Iavg Zfac Complete

Conc = 1e19;
L = 200e-9;
W = 100e-9;
V0 = Vin(J);

fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
La = linspace(0,L,nx);
Wa = linspace(0,W,ny);
G = sparse(nx*ny);
%V = sparse(nx,ny);
F = sparse(1,nx*ny);


Acond = 1;              % background conductivity of region, low resistance
Bcond = 1e-2;           % Conductivity of boxes, highly resistive
cMap = zeros(nx,ny);
Lb = 40e-9;
Wb = 40e-9;
for u = 1:nx
    for v = 1:ny
        if (u >= 80 && u <= 120)
            if v >= 0 && v <= 40-1+J
                cMap(u,v) = Bcond;
            elseif v >= 60+1-J && v <= 100
                cMap(u,v) = Bcond;
            else
                cMap(u,v) = Acond;
            end
        else
            cMap(u,v) = Acond;
        end
    end
end





for i = 1:nx                %Iteration through length
    for j = 1:ny            %Iteration through width
        n = j + (i-1)*ny;

        if i == 1          % x=0 BCs
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = V0;
        elseif i == nx     % x=1 BCs
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = 0;       %F(n)=0 sets z at final width to 0
            
% COMMENT BELOW FOR 1a
            %F(n) = 1;       %F(n)=1 sets z at final width to 1
            
        elseif j == 1                 % y=0 BCs
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;
            
            G(n,n) = -(rxm+rxp+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nyp) = ryp;

        elseif j == ny                % y=1 BCs
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;
            
            G(n,n) = -(rxm+rxp+rym);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;
            
            
% COMMENT ABOVE FOR 1a
            
        else
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;
            
            G(n,n) = -(rxm+rxp+rym+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;
            G(n,nyp) = ryp;
        end
            
    end
end
% figure(1)
% spy(G)

V = G\F';

Vmap = zeros(nx,ny);
for i = 1:nx
    for j = 1:ny
        n = j + (i-1)*ny;
        Vmap(i,j) = V(n);
    end
end


for i = 1:nx
    for j = 1:ny
        if i == 1
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i, j));
        elseif i == nx
            Ex(i, j) = (Vmap(i, j) - Vmap(i - 1, j));
        else
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i - 1, j)) * 0.5;
        end
        if j == 1
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j));
        elseif j == ny
            Ey(i, j) = (Vmap(i, j) - Vmap(i, j - 1));
        else
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j - 1)) * 0.5;
        end
    end
end

Ex = -Ex;
Ey = -Ey;

eFlowx = cMap .* Ex;        %Jx
eFlowy = cMap .* Ey;        %Jy
C0 = sum(eFlowx(1, :));
Cnx = sum(eFlowx(nx, :));
Curr = (C0 + Cnx) * 0.5;

Ex = Ex';
Ey = Ey';

% figure(4)
% subplot(1, 2, 2), quiver(Ex, Ey);
% axis([0 nx 0 ny]);
% title('Electric Field Map')
% xlabel('Region Length')
% ylabel('Region Width')
% pbaspect([1 1 0.5])
% subplot(1, 2, 1), H = surf(La,Wa,Vmap');
% set(H, 'linestyle', 'none');
% %view(90, 270)
% title('Voltage Map')
% xlabel('Region Length')
% ylabel('Region Width')
% pbaspect([1 1 0.5])
% saveas(gcf,'Figure4')

% clearvars -except Ex Ey

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Beginning Monte Carlo Simulation
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH


set(0,'DefaultFigureWindowStyle','docked')
set(0,'defaultaxesfontsize',10)
set(0,'defaultaxesfontname','Times New Roman')
set(0,'DefaultLineLineWidth', 0.5);



global C

C.q_0 = 1.60217653e-19;             % electron charge
C.hb = 1.054571596e-34;             % Dirac constant
C.h = C.hb * 2 * pi;                % Planck constant
C.m_0 = 9.10938215e-31;             % electron mass
C.kb = 1.3806504e-23;               % Boltzmann constant
C.eps_0 = 8.854187817e-12;          % vacuum permittivity
C.mu_0 = 1.2566370614e-6;           % vacuum permeability
C.c = 299792458;                    % speed of light
C.g = 9.80665;                      % metres (32.1740 ft) per sÂ²
C.m_n = 0.26 * C.m_0;               % effective electron mass
C.am = 1.66053892e-27;              % atomic mass unit
C.T = 300;
C.vth = sqrt(2*C.kb * C.T / C.m_n);

temp = C.T;

SPECDIFF_BOUND = 0;

% figure(3)
% subplot(2,1,1);
% rectangle('Position',[0 0 200e-9 100e-9])
% hold on
% rectangle('Position',[0.8e-7 0 0.4e-7 0.4e-7])
% hold on
% rectangle('Position',[0.8e-7 0.6e-7 0.4e-7 0.4e-7])
% hold on

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Initializing Positions
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

    N = 30000;        % Number of electrons
    i = 0;
    j = 0;

    for i=1:N
        px(i) = 0 + (200e-9 - 0).*rand(1,1);
        py(i) = 0 + (100e-9 - 0).*rand(1,1);
        while (0.8e-7 <= px(i) && px(i) <= 1.2e-7) && (0 <= py(i) && py(i) <= (0.4e-7 - Zfac) ) ||...
                (0.8e-7 <= px(i) && px(i) <= 1.2e-7) && ((0.6e-7 + Zfac) <= py(i) && py(i) <= 1e-7)
            px(i) = 0 + (200e-9 - 0).*rand(1,1);
            py(i) = 0 + (100e-9 - 0).*rand(1,1);
        end
    end

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Voltage Applied Across x-Dimension to Find Electric Field
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

    V0x = Vin(J);
    V0y = 0;
    L = 200e-9;
    W = 100e-9;
    % E0x = V0x / L;
    % E0y = V0y / W;
    fMesh = 1;
    nx = fMesh*200;
    ny = fMesh*100;
    % G = sparse(nx,ny);
    % F = sparse(1,nx*ny);

    La = linspace(0,L,nx);
    Wa = linspace(0,W,ny);

    deltax = L/nx;
    deltay = W/ny;

    Ex = Ex./deltax;
    Ey = Ey./deltay;

    % Emapx = zeros(ny,nx);
    Emapx = Ex;
    % Emapy = zeros(ny,nx);
    Emapy = Ey;

    % for i = 1:width(La)
    %     for j = 1:width(Wa)
    %         Emapx(j,i) = E0x;
    %         Emapy(j,i) = E0y;
    %     end
    % end
    % %surf(La,Wa,Emapx)
    %
    % Fex = abs(C.q_0*E0x);
    % aex = Fex/C.m_n;
    % Fey = abs(C.q_0*E0y);
    % aey = Fey/C.m_n;

    Fex = zeros(ny,nx);
    aex = zeros(ny,nx);
    Fey = zeros(ny,nx);
    aey = zeros(ny,nx);

    for i = 1:width(Wa)
        for j = 1:width(La)
            Fex(i,j) = abs(C.q_0*Emapx(i,j));
            aex(i,j) = Fex(i,j)/C.m_n;
            Fey(i,j) = abs(C.q_0*Emapy(i,j));
            aey(i,j) = Fey(i,j)/C.m_n;
        end
    end





%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Thermal Velocity and Direction
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

    vth = C.vth;

    for j=1:N
        vx(j) = (vth/sqrt(2))*randn();
        vy(j) = (vth/sqrt(2))*randn();
        vth_calc(j) = sqrt(vx(j)^2 + vy(j)^2);
    end


    t = 0;
    T(1) = 0;
    dt = 1e-14;     % time step

    for l=1:N           %Scattering time step
        ndt(l) = dt;
    end
    P_scat = 0;
    Tmn = 0.2e-12;

    px_prev = 0;
    py_prev = 0;
    T_prev = 0;
    vx_total = 0;
    vy_total = 0;

    sampleidx = randi(N,10,1);
    Ix = 0;
    Jx = 0;
    aex = aex';
    aey = aey';




    for t=2:1000
        vx_total = 0;
        vy_total = 0;
        for k=1:N

            rpx = 0;
            rpy = 0;
            if px(k) == 200e-9
                px(k) = 0;
                px_prev(k) = px(k);
            elseif px(k) == 0
                px(k) = 200e-9;
                px_prev(k) = px(k);
            else
                px(k) = px(k);
            end

            P_scat(k) = 1 - exp(-(dt/Tmn));
            if P_scat(k) > rand()
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            else
                ndt(k) = ndt(k) + dt;
            end

            px_prev(k) = px(k);
            py_prev(k) = py(k);

            rpx = round(px(k)*1e9);
            if rpx == 0
                rpx = 1;
            end
            rpy = round(py(k)*1e9);
            if rpy == 0
                rpy = 1;
            end



            px(k) = px(k) + vx(k)*dt + aex(rpx,rpy)*dt^2;        % Adding acceleration
            vx(k) = vx(k) + aex(rpx,rpy)*dt;
            py(k) = py(k) + vy(k)*dt + aey(rpx,rpy)*dt^2;
            vy(k) = vy(k) + aey(rpx,rpy)*dt;


            % Reflection on top and bottom borders
            if py(k) >= 100e-9 || py(k) <= 0
                vy(k) = -vy(k);
                if py(k) >= 100e-9
                    py(k) = 100e-9;
                end
                if py(k) <= 0
                    py(k) = 0;
                end
            end
            % Reflection on bottom of upper box
            if (py(k) >= (0.6e-7 + Zfac)) && (0.8e-7 <= px(k) && px(k) <= 1.2e-7)...
                    && ( 0.8e-7 <= px_prev(k) && px_prev(k) <= 1.2e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vy(k) = -vy(k);
                end
                py(k) = 0.601e-7 + Zfac;
                %end
                % Reflection on top of lower box
            elseif (py(k) <= 0.4e-7 - Zfac) && (0.8e-7 <= px(k) && px(k) <= 1.2e-7)...
                    && (0.8e-7 <= px_prev(k) && px_prev(k) <= 1.2e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vy(k) = -vy(k);
                end
                py(k) = 0.399e-7 - Zfac;
                %end
                % Reflection on left of lower box
            elseif (0 <= py(k) && py(k) <= 0.4e-7 - Zfac) && (0.8e-7 <= px(k) && px(k) <= 1e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vx(k) = -vx(k);
                end
                px(k) = 0.799e-7;
                %end
                % Reflection on right of lower box
            elseif (0 <= py(k) && py(k) <= 0.4e-7 - Zfac) && (1e-7 <= px(k) && px(k) <= 1.2e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vx(k) = -vx(k);
                end
                px(k) = 1.201e-7;
                %end
                % Reflection on left of upper box
            elseif (0.6e-7 + Zfac <= py(k) && py(k) <= 1e-7) && (0.8e-7 <= px(k) && px(k) <= 1e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vx(k) = -vx(k);
                end
                px(k) = 0.799e-7;
                %end
                % Reflection on right of upper box
            elseif (0.6e-7 + Zfac <= py(k) && py(k) <= 1e-7) && (1e-7 <= px(k) && px(k) <= 1.2e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vx(k) = -vx(k);
                end
                px(k) = 1.201e-7;
            end

            % x-axis transition
            if px(k) > 200e-9
                px(k) = 200e-9;
                %             px_prev(k) = px(k);
            elseif px(k) < 0
                px(k) = 0;
                %             px_prev(k) = px(k);
            else
                px(k) = px(k);
            end

            v(k) = sqrt(vx(k)^2 + vy(k)^2);
            v2(k) = v(k).*v(k);

            vx_total = vx_total + vx(k);        % Drift velocity x
            vy_total = vy_total + vy(k);        % Drift velocity y
        end
        vx_total_alt = sum(vx);



        vx_drift = 1/N * vx_total;
        vy_drift = 1/N * vy_total;
        Jx = C.q_0 * Conc * vx_drift;   %Concentration = 1e19 per m^-2
        Ix_prev = Ix;
        Ix = Jx * W;
        Ix_total(t) = Ix;



    end

    
    Iavg(J) = mean(Ix_total);
    %bottleneck(J) = 20e-9 - (2*g) + 2e-9;


end

figure(1)
plot(Vin,Iavg)
xlabel('Input Voltage (V)')
ylabel('Average Current (A)')
title('Average Current VS Input Voltage')
saveas(gcf,'Figure1')

%% Section 1.2: Calculating the resistance of R3
% The solved resistance of R3 was then found to be approximately 51.32 
% ohms, found through a linear fit of the plot.

linFit = polyfit(Vin,Iavg,1);
G3 = linFit(1);
R3 = 1/G3;

fprintf('\nThe resistance of R3 is %f ohms.',R3);
clearvars -except R3

%% Section 1.3: The C and G matricies
% Using code from PA7, the C and G matricies of the circuit were formed are
% are displayed below.

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Reusing Modified Nodal Analysis Code for Circuit - DC Case
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

global G b C
nodes = 6;
G = sparse(nodes,nodes);
C = sparse(nodes,nodes);
b = sparse(nodes,1);

% MNA setup
Vin = 1;
Vprobe = 0;
R1 = 1;
R2 = 2;
%R3 = 10; %R3 found in part 1
R4 = 0.1;
R5 = 1000;
C1 = 0.25;
L1 = 0.2;
alpha = 100;

cap(1,2,C1);
res(1,2,R1);
res(2,0,R2);
res(3,6,R3);
res(4,5,R4);
res(5,0,R5);
xr = vol(6,0,Vprobe);
ind(2,3,L1);
vol(1,0,Vin);
vcvs(4,0,xr,0,alpha);

w = 0;
s = j*w;

A = G + s*C;
A0 = full(A);
G0 = full(G);
C0 = full(C);

fprintf('\nThe G matrix is given as:\n');
disp(G0);

fprintf('\nThe C matrix is given as:\n');
disp(C0);

%% Section 1.4: DC Sweep of Vin from -10V to 10V
% Next, the value of Vin (at node 1) was swept from -10V to 10V and the
% resulting output at node 3 and the output were plotted.

V0 = linspace(-10,10,21);
b0 = sparse((width(G)),width(V0));
for i = 1:width(V0)
    b0(9,i) = V0(i);
end

x = sparse((width(G)),width(V0));

for j = 1:width(V0)
    x(:,j) = (G + s*C) \ b0(:,j);
end

figure(2)
plot(V0,x(5,:))
hold on
plot(V0,x(3,:))
grid on
axis([-10 10 -100 100])
title('Vout vs Vin')
xlabel('Vin')
ylabel('Vout')
legend('Vout','V3')
saveas(gcf,'Figure2')
hold off

%% Section 1.5: The AC Case; Vout as a function of w
% Vout was then plotted as a function of w (omega), where omega was swept
% from 0Hz to 100Hz over 100 points.

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% AC Case
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

clearvars -except R3
global G b C
nodes = 6;
G = sparse(nodes,nodes);
C = sparse(nodes,nodes);
b = sparse(nodes,1);

% MNA setup
Vin = 1;
Vprobe = 0;
R1 = 1;
R2 = 2;
%R3 = 10;
R4 = 0.1;
R5 = 1000;
C1 = 0.25;
L1 = 0.2;
alpha = 100;

cap(1,2,C1);
res(1,2,R1);
res(2,0,R2);
res(3,6,R3);
res(4,5,R4);
res(5,0,R5);
xr = vol(6,0,Vprobe);
ind(2,3,L1);
vol(1,0,Vin);
vcvs(4,0,xr,0,alpha);

w = linspace(0,100,100);
s = j*w;

% A = G + s.*C;
% A0 = full(A);

%V0 = linspace(-10,10,21);
% b0 = sparse((width(G)),width(w));
% for i = 1:width(w)
%     b0(6,i) = V0(i);
% end

% x = (G + s*C) \ b;
x = sparse((width(G)),width(w));

for i = 1:width(w)
    x(:,i) = (G + s(i)*C) \ b;
end
    
figure(3)
plot(w,abs(x(5,:)))
%hold on
%plot(w,abs(x(3,:)))
grid on
title('|Vout| vs Frequency')
xlabel('Frequency (Hz)')
ylabel('Voltage (V)')
%legend('Vout','V3')
saveas(gcf,'Figure3')
hold off

%% Section 1.6: The AC Case; Plotting Vo/Vi in dB
% The gain of Vout over Vin was also plotted, in dB.

mag = abs(x(5,:)./x(1,:));
gain = mag2db(mag);
figure(4)
plot(w,gain)
grid on
title('Gain vs Frequency')
ylabel('Gain (dB)')
xlabel('Frequency')
saveas(gcf,'Figure4')





##### SOURCE END #####
--></body></html>